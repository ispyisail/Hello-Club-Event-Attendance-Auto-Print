<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hello Club Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <span class="status-dot unknown" id="status-dot"></span>
      <h1>Hello Club Event Attendance</h1>
      <span class="header-status" id="header-status">Connecting...</span>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="logs">Logs</button>
      <button class="tab" data-tab="config">Config</button>
    </nav>

    <main class="content">
      <!-- Dashboard Panel -->
      <section class="panel active" id="panel-dashboard">
        <div id="dashboard-alert" class="alert"></div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0; font-size: 18px;">Service Statistics</h2>
          <div class="btn-group">
            <button class="btn" onclick="loadDashboard()">Refresh Dashboard</button>
            <button class="btn btn-primary" onclick="refreshEventsFromHelloClub()">üîÑ Refresh from Hello Club</button>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-title">Events (Last 7 Days)</div>
            <div class="stat"><span class="stat-label">Total</span><span class="stat-value" id="events-total">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Processed</span><span class="stat-value ok" id="events-processed">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Failed</span><span class="stat-value bad" id="events-failed">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Success Rate</span><span class="stat-value" id="events-rate">‚Äî</span></div>
          </div>
          <div class="card">
            <div class="card-title">Jobs (Last 7 Days)</div>
            <div class="stat"><span class="stat-label">Total</span><span class="stat-value" id="jobs-total">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Completed</span><span class="stat-value ok" id="jobs-completed">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Failed</span><span class="stat-value bad" id="jobs-failed">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Retry Rate</span><span class="stat-value warn" id="jobs-retry-rate">‚Äî</span></div>
          </div>
          <div class="card">
            <div class="card-title">Current Queue</div>
            <div class="stat"><span class="stat-label">Pending</span><span class="stat-value" id="q-pending">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Retrying</span><span class="stat-value warn" id="q-retrying">‚Äî</span></div>
            <div class="stat"><span class="stat-label">Failed</span><span class="stat-value bad" id="q-failed">‚Äî</span></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Upcoming Scheduled Events</div>
          <div id="upcoming-events"><div class="empty-state">No upcoming events scheduled</div></div>
        </div>

        <div class="card">
          <div class="card-title">Recent Activity</div>
          <div id="recent-activity"><div class="empty-state">No recent activity</div></div>
        </div>

        <p class="text-muted" style="font-size:11px;margin-top:8px;">
          Auto-refreshes every 30s &mdash; Last updated: <span id="last-updated">‚Äî</span>
        </p>
      </section>

      <!-- Logs Panel -->
      <section class="panel" id="panel-logs">
        <div class="card">
          <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
            Live Log Stream
            <span class="btn-group">
              <button class="btn btn-sm" id="btn-pause" onclick="togglePause()">Pause</button>
              <button class="btn btn-sm" onclick="clearLogs()">Clear</button>
            </span>
          </div>
          <div class="log-container" id="log-container"></div>
          <p class="text-muted mt-2" style="font-size:11px;" id="ws-status">Connecting to log stream...</p>
        </div>
      </section>

      <!-- Config Panel -->
      <section class="panel" id="panel-config">
        <div id="config-alert" class="alert"></div>

        <!-- Sticky Save Bar -->
        <div id="sticky-save-bar" class="sticky-save-bar">
          <div class="sticky-save-content">
            <span class="sticky-save-message">‚ö†Ô∏è You have unsaved changes</span>
            <button class="btn btn-primary" onclick="saveAllConfig()">üíæ Save All Settings</button>
          </div>
        </div>

        <!-- Section 1: API Settings -->
        <div class="config-section collapsed" id="section-api">
          <div class="config-section-header" onclick="toggleSection('section-api')">
            <span class="config-section-arrow">&#9660;</span>
            API Settings
          </div>
          <div class="config-section-body">
            <div class="form-group">
              <label class="form-label" for="cfg-api-key">API Key</label>
              <div class="password-wrapper">
                <input type="password" class="form-control" id="cfg-api-key" placeholder="Enter Hello Club API key">
                <button type="button" class="password-toggle" onclick="togglePassword('cfg-api-key')" title="Show/hide">&#128065;</button>
              </div>
              <div class="field-hint">Required. Your Hello Club API key for authentication.</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="cfg-api-base-url">API Base URL</label>
              <input type="text" class="form-control" id="cfg-api-base-url" placeholder="https://api.helloclub.com">
              <div class="field-hint">Optional. Override the default API endpoint.</div>
            </div>
            <div class="btn-group mt-2">
              <button class="btn" onclick="testApi()">Test API Connection</button>
            </div>
          </div>
        </div>

        <!-- Section 2: Email & Printing -->
        <div class="config-section collapsed" id="section-printing">
          <div class="config-section-header" onclick="toggleSection('section-printing')">
            <span class="config-section-arrow">&#9660;</span>
            Email &amp; Printing
          </div>
          <div class="config-section-body">
            <div class="form-group">
              <label class="form-label" for="cfg-print-mode">Print Mode</label>
              <select class="form-control" id="cfg-print-mode" onchange="updatePrintModeFields()">
                <option value="email">Email to Printer</option>
                <option value="local">Local Printer (CUPS)</option>
              </select>
            </div>

            <div id="email-fields">
              <div class="form-group">
                <label class="form-label" for="cfg-printer-email">Printer Email</label>
                <input type="email" class="form-control" id="cfg-printer-email" placeholder="your.printer@hp.com">
                <div class="field-hint">The email address of your network printer.</div>
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-smtp-host">SMTP Host</label>
                <input type="text" class="form-control" id="cfg-smtp-host" placeholder="smtp.gmail.com">
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-smtp-port">SMTP Port</label>
                <input type="number" class="form-control" id="cfg-smtp-port" placeholder="587">
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-smtp-user">SMTP User</label>
                <input type="text" class="form-control" id="cfg-smtp-user" placeholder="your.email@gmail.com">
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-smtp-pass">SMTP Password</label>
                <div class="password-wrapper">
                  <input type="password" class="form-control" id="cfg-smtp-pass" placeholder="App password">
                  <button type="button" class="password-toggle" onclick="togglePassword('cfg-smtp-pass')" title="Show/hide">&#128065;</button>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-email-from">Email From</label>
                <input type="email" class="form-control" id="cfg-email-from" placeholder="sender@example.com">
                <div class="field-hint">Optional. Defaults to SMTP User if blank.</div>
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-notification-email-2">Notification Email</label>
                <input type="email" class="form-control" id="cfg-notification-email-2" placeholder="your.email@example.com">
                <div class="field-hint">Optional. Receive a copy of printed PDFs by email for verification.</div>
              </div>
              <div class="btn-group mt-2">
                <button class="btn" onclick="testEmail()">Test Email Connection</button>
                <button class="btn btn-primary" onclick="testPrintEvent()">üìÑ Print Next Event</button>
                <button class="btn" style="background:#ff6b35;color:white;" onclick="simulateTrigger()">üé¨ Simulate Trigger</button>
                <button class="btn" onclick="generatePreview()">üëÅÔ∏è Preview PDF</button>
              </div>
              <div class="field-hint" style="margin-top:4px;font-size:10px;">
                "Print Next Event" prints manually. "Simulate Trigger" tests the full automated workflow. "Preview PDF" shows sample data.
              </div>
            </div>

            <div id="local-fields" style="display:none;">
              <div class="form-group">
                <label class="form-label" for="cfg-printer-name">Printer Name</label>
                <input type="text" class="form-control" id="cfg-printer-name" placeholder="e.g. HP_LaserJet">
                <div class="field-hint">Optional. CUPS printer name. Leave blank for default printer.</div>
              </div>
              <div class="form-group">
                <label class="form-label" for="cfg-notification-email">Notification Email</label>
                <input type="email" class="form-control" id="cfg-notification-email" placeholder="your.email@example.com">
                <div class="field-hint">Optional. Receive a copy of printed PDFs by email for verification.</div>
              </div>
              <div class="btn-group mt-2">
                <button class="btn" onclick="scanForPrinters()">üîç Search for Printers</button>
                <button class="btn" onclick="testPrint()">Test Print (CUPS)</button>
                <button class="btn btn-primary" onclick="testPrintEvent()">üìÑ Print Next Event</button>
                <button class="btn" style="background:#ff6b35;color:white;" onclick="simulateTrigger()">üé¨ Simulate Trigger</button>
                <button class="btn" onclick="generatePreview()">üëÅÔ∏è Preview PDF</button>
              </div>
              <div class="field-hint" style="margin-top:4px;font-size:10px;">
                "Print Next Event" prints manually. "Simulate Trigger" tests the full automated workflow. "Preview PDF" shows sample data.
              </div>
              <div id="printer-scan-results" style="margin-top:12px;display:none;">
                <div class="field-hint" style="margin-bottom:8px;">Found Printers:</div>
                <div id="printer-list" class="printer-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Event Categories -->
        <div class="config-section collapsed" id="section-categories">
          <div class="config-section-header" onclick="toggleSection('section-categories')">
            <span class="config-section-arrow">&#9660;</span>
            Event Categories
          </div>
          <div class="config-section-body">
            <div class="field-hint" style="margin-bottom:8px;">Only events matching these categories will be processed. Leave empty to process all events.</div>
            <div class="category-list" id="category-list"></div>
            <div class="form-group mt-2" style="display:flex;gap:6px;">
              <input type="text" class="form-control" id="cfg-new-category" placeholder="Add a category..." style="flex:1;" onkeydown="if(event.key==='Enter'){addCategory();event.preventDefault();}">
              <button class="btn" onclick="addCategory()">Add</button>
              <button class="btn" onclick="openCategoryFetchModal()">Fetch from Hello Club</button>
            </div>
          </div>
        </div>

        <!-- Section 4: Advanced Settings -->
        <div class="config-section collapsed" id="section-advanced">
          <div class="config-section-header" onclick="toggleSection('section-advanced')">
            <span class="config-section-arrow">&#9660;</span>
            Advanced Settings
          </div>
          <div class="config-section-body">
            <div class="form-group">
              <label class="form-label" for="cfg-pre-event-minutes">Pre-Event Query (minutes)</label>
              <input type="number" class="form-control" id="cfg-pre-event-minutes" placeholder="5">
              <div class="field-hint">How many minutes before an event starts to fetch the latest attendee list, generate the PDF, and print it. For example, "5" means the PDF will be ready 5 minutes before the event begins.</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="cfg-fetch-window-hours">Fetch Window (hours)</label>
              <input type="number" class="form-control" id="cfg-fetch-window-hours" placeholder="168">
              <div class="field-hint">How far ahead to look for upcoming events (168 = 1 week).</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="cfg-service-interval">Service Run Interval (hours)</label>
              <input type="number" class="form-control" id="cfg-service-interval" placeholder="1">
              <div class="field-hint">How often the service checks for new events.</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="cfg-output-filename">Output Filename</label>
              <input type="text" class="form-control" id="cfg-output-filename" placeholder="attendees.pdf">
            </div>
            <div class="form-group">
              <label class="form-label" for="cfg-pdf-font-size">PDF Font Size</label>
              <input type="number" class="form-control" id="cfg-pdf-font-size" placeholder="10">
              <div class="field-hint">Base font size for PDF (default: 10pt).</div>
            </div>
            <div class="form-group">
              <label class="form-label">Logo</label>
              <div id="logo-upload-area" class="logo-upload-area">
                <input type="file" id="logo-file-input" accept="image/png,image/jpeg" style="display:none;" onchange="handleLogoSelect(event)">
                <div id="logo-drop-zone" class="logo-drop-zone" onclick="document.getElementById('logo-file-input').click()">
                  <div id="logo-preview-container" style="display:none;">
                    <img id="logo-preview" class="logo-preview" alt="Logo preview">
                    <button type="button" class="btn btn-sm" onclick="removeLogo();event.stopPropagation()">Remove</button>
                  </div>
                  <div id="logo-upload-prompt">
                    <span>üì∑ Click or drag image here</span>
                    <div class="field-hint">PNG or JPEG, max 2MB</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Column Configuration</label>
              <div class="field-hint" style="margin-bottom:8px;">Drag to reorder columns. Uncheck to hide.</div>
              <div id="column-config-list" class="column-config-list"></div>
            </div>
            <div class="form-group">
              <label class="form-label">PDF Preview</label>
              <button class="btn" onclick="generatePreview()">Generate Sample PDF</button>
              <div class="field-hint">Creates a sample PDF with mock data using current layout settings</div>
            </div>
          </div>
        </div>

        <div class="btn-group mt-2" style="margin-bottom:14px;">
          <button class="btn btn-primary" onclick="saveAllConfig()">Save All Settings</button>
        </div>
      </section>
    </main>

    <!-- Category Fetch Modal -->
    <div class="modal" id="category-fetch-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Fetch Categories from Hello Club</h3>
          <button class="modal-close" onclick="closeCategoryFetchModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group" style="display:flex;gap:6px;align-items:flex-end;">
            <div style="flex:1;">
              <label class="form-label" for="fetch-days">Search ahead (days)</label>
              <input type="number" class="form-control" id="fetch-days" value="30" min="1" max="100">
              <div class="field-hint">Default: 30 days, Maximum: 100 days</div>
            </div>
            <button class="btn btn-primary" onclick="fetchCategoriesFromApi()">Search</button>
          </div>

          <div id="category-fetch-results" style="display:none;">
            <div style="margin:16px 0 8px 0;display:flex;justify-content:space-between;align-items:center;">
              <div id="category-fetch-summary" style="font-size:12px;color:#666;"></div>
              <div style="font-size:11px;color:#888;" id="category-fetch-timestamp"></div>
            </div>

            <div id="category-fetch-list" class="fetched-category-list"></div>

            <div class="btn-group mt-2">
              <button class="btn" onclick="selectAllFetchedCategories()">Select All</button>
              <button class="btn" onclick="deselectAllFetchedCategories()">Deselect All</button>
              <button class="btn btn-primary" onclick="addSelectedCategories()">Add Selected</button>
            </div>
          </div>

          <div id="category-fetch-loading" style="display:none;text-align:center;padding:20px;">
            <div style="font-size:14px;color:#666;">Fetching categories from Hello Club...</div>
          </div>

          <div id="category-fetch-error" style="display:none;" class="alert alert-error show"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
</body>
</html>
